<!DOCTYPE html> 
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>資料管理系統</title>
  <style>
    select {
    font-size: 16px; /* 調整字體大小 */
    }
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .form-group {
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    button {
      margin-right: 5px;
    }
    input {
      width: 100%;
      max-width: 200px;
    }
  </style>
</head>
<body>

<h1>資料管理系統</h1>

<!-- 輸入區塊 -->
<div id="formArea">
  <h2>輸入/搜尋資料</h2>
  <form id="dataForm">
    <div class="form-group">
      <label for="region">區域:</label>
      <select id="region">
        <option value="">請選擇</option>
        <option value="北區">北區</option>
        <option value="中區">中區</option>
        <option value="南區">南區</option>
        <option value="庫房">庫房</option>
      </select>
    </div>
    <div class="form-group">
      <label for="person">人員:</label>
      <select id="person">
      <option value="">請選擇</option>
      </select>
    </div>
   <div class="form-group">
  <label for="instrument">儀器種類:</label>
  <select id="instrument">
    <option value="">請選擇</option>
    <option value="InfoV.A.C">InfoV.A.C</option>
    <option value="ActiV.A.C">ActiV.A.C</option>
    <option value="ULTA">ULTA</option>
    <!-- 可根據需要添加更多選項 -->
  </select>
</div>
    <div class="form-group">
      <label for="serial">序號:</label>
      <input type="text" id="serial">
    </div>
    <div class="form-group">
      <label for="date">日期:</label>
      <input type="date" id="date">
    </div>
    <div class="form-group">
      <label for="oldhospital">原醫院:</label>
      <input type="text" id="oldhospital">
    </div>
    <div class="form-group">
      <label for="location">原地點:</label>
      <input type="text" id="oldlocation">
    </div>
      <div class="form-group">
      <label for="hospital">醫院:</label>
      <input type="text" id="hospital">
    </div>
    <div class="form-group">
      <label for="location">地點:</label>
      <input type="text" id="location">
    </div>
     <div class="form-group">
      <label for="patient">醫生姓名:</label>
      <input type="text" id="doctor">
    </div>
      <div class="form-group">
      <label for="patient">病人姓名:</label>
      <input type="text" id="patient">
    </div>
    <div class="form-group">
      <label for="product">搭配產品:</label>
      <input type="text" id="product">
    </div>
    <div class="form-group">
  <label for="stockStatus">庫房狀態:</label>
  <select id="stockStatus">
    <option value="">請選擇</option>
    <option value="不在庫">不在庫</option>
    <option value="已入庫可領取">已入庫可領取</option>
    <option value="出售">出售</option>
    <option value="提供緊急使用">提供緊急使用</option>
    <option value="維修完成可領取">維修完成可領取</option>
    <option value="維修中">維修中</option>
    <option value="可領取">可領取</option>
    <option value="報廢">報廢</option>
    <option value="送原廠">送原廠</option>
    <!-- 可根據需要添加更多選項 -->
  </select>
</div>
    <button type="submit" id="submitButton">提交</button>
    <button type="button" id="searchButton">搜尋</button>
  </form>
</div>

<!-- 結果顯示區 -->
<div id="resultArea">
  <table>
    <thead>
      <tr>
        <th>區域</th>
        <th>人員</th>
        <th>儀器種類</th>
        <th>序號</th>
        <th>日期</th>
        <th>原醫院</th>
        <th>原地點</th>  
        <th>醫院</th>
        <th>地點</th>
        <th>醫生姓名</th>
        <th>病人姓名</th>
        <th>搭配產品</th>
        <th>庫房狀態</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="resultTable">
      <tr><td colspan="14">尚無資料</td></tr>
    </tbody>
  </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
  import { getFirestore, collection, addDoc, query, where, getDocs, updateDoc, deleteDoc, doc , getDoc} from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBgAxfANocYJ36xlBXwAgK0-lOCGv9b3zg",
    authDomain: "crud-form-bf621.firebaseapp.com",
    projectId: "crud-form-bf621",
    storageBucket: "crud-form-bf621.appspot.com",
    messagingSenderId: "803143241263",
    appId: "1:803143241263:web:8f7dc84a10cd0d0c5b40da"
  };

  const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
 // 新增函數，獲取文檔數量並更新頁面
  async function updateDocCount() {
    try {
      // 從 Firestore 獲取集合的所有文檔
      const snapshot = await getDocs(collection(db, "佑康測試"));
      const count = snapshot.size; // 獲取文檔數量

      // 更新頁面中的文字內容
      document.getElementById("docCount").textContent = count;
    } catch (error) {
      console.error("獲取文檔數量失敗：", error);
    }
  }

  // 在頁面加載時執行該函數
  updateDocCount();
// 監聽區域選擇的變更
document.getElementById("region").addEventListener("change", async function () {
  const region = this.value; // 取得選中的區域
  const personSelect = document.getElementById("person");

  // 清空人員下拉選單
  personSelect.innerHTML = '<option value="">請選擇</option>';

  if (region === "庫房") {
    return; // 如果是庫房，保持空白
  }

  try {
    // 從 Firestore 取得對應的區域人員資料
    const settingsDocRef = doc(db, "佑康設定", "佑康人員");
    const settingsDoc = await getDoc(settingsDocRef);

    if (settingsDoc.exists()) {
      const data = settingsDoc.data();
      const people = data[`${region}人員`] || []; // 預設為空陣列

      // 確保人員資料是陣列格式
      if (Array.isArray(people)) {
        people.forEach(person => {
          const option = document.createElement("option");
          option.value = person;
          option.textContent = person;
          personSelect.appendChild(option);
        });
      } else {
        // 若資料不是陣列，檢查是否是字串，並轉換為陣列
        if (typeof people === 'string') {
          const personArray = people.split(','); // 假設字串是以逗號分隔
          personArray.forEach(person => {
            const option = document.createElement("option");
            option.value = person.trim(); // 去掉多餘的空格
            option.textContent = person.trim();
            personSelect.appendChild(option);
          });
        } else {
          console.error(`${region} 人員資料格式不正確，應該是陣列`);
        }
      }
    } else {
      console.error("找不到設定文件");
    }
  } catch (error) {
    console.error("讀取人員資料失敗：", error);
  }
});



  // 提交表單事件
  document.getElementById("dataForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = {
      區域: document.getElementById("region").value,
      人員: document.getElementById("person").value,
      儀器種類: document.getElementById("instrument").value,
      序號: document.getElementById("serial").value,
      日期: document.getElementById("date").value,
      原醫院: document.getElementById("oldhospital").value,
      原地點: document.getElementById("oldlocation").value,
      醫院: document.getElementById("hospital").value,
      地點: document.getElementById("location").value,
      醫生姓名: document.getElementById("doctor").value,    
      病人姓名: document.getElementById("patient").value,
      搭配產品: document.getElementById("product").value,
      庫房狀態: document.getElementById("stockStatus").value
    };

    if (!formData.區域) {
      alert("請選擇區域！");
      return;
    }

    try {
      const queryRef = query(
        collection(db, "佑康測試"),
        where("區域", "==", formData.區域),
        where("人員", "==", formData.人員),
        where("儀器種類", "==", formData.儀器種類),
        where("序號", "==", formData.序號)
      );
      const querySnapshot = await getDocs(queryRef);

      if (!querySnapshot.empty) {
        const docId = querySnapshot.docs[0].id;
        const docRef = doc(db, "佑康測試", docId);
        await updateDoc(docRef, formData);
        alert("資料已更新！");
      } else {
        await addDoc(collection(db, "佑康測試"), formData);
        alert("資料已新增！");
      }

      document.getElementById("dataForm").reset();
    } catch (error) {
      console.error("提交資料失敗：", error);
      alert("提交失敗，請稍後再試！");
    }
  });

 // 搜尋按鈕事件
document.getElementById("searchButton").addEventListener("click", async () => {
  const region = document.getElementById("region").value;
  const person = document.getElementById("person").value;
  const instrument = document.getElementById("instrument").value;  // 修正名稱
  const serial = document.getElementById("serial").value;  // 修正名稱
  const date = document.getElementById("date").value;
  const oldhospital = document.getElementById("oldhospital").value;
  const oldlocation = document.getElementById("oldlocation").value;     
  const hospital = document.getElementById("hospital").value;
  const location = document.getElementById("location").value;
  const doctor = document.getElementById("doctor").value;     
  const patient = document.getElementById("patient").value;  // 修正名稱
  const product = document.getElementById("product").value;
  const stockStatus = document.getElementById("stockStatus").value;  // 修正名稱

  const queryConditions = [];

  if (region) queryConditions.push(where("區域", "==", region));
  if (person) queryConditions.push(where("人員", "==", person));
  if (instrument) queryConditions.push(where("儀器種類", "==", instrument));
  if (serial) queryConditions.push(where("序號", "==", serial));
  if (date) queryConditions.push(where("日期", "==", date));
  if (oldhospital) queryConditions.push(where("原醫院", "==", oldhospital));
  if (oldlocation) queryConditions.push(where("原地點", "==", oldlocation));     
  if (hospital) queryConditions.push(where("醫院", "==", hospital));
  if (location) queryConditions.push(where("地點", "==", location));
  if (doctor) queryConditions.push(where("醫生姓名", "==", doctor));     
  if (patient) queryConditions.push(where("病人姓名", "==", patient));
  if (product) queryConditions.push(where("搭配產品", "==", product));
  if (stockStatus) queryConditions.push(where("庫房狀態", "==", stockStatus));

  if (queryConditions.length === 0) {
    alert("請至少選擇一個搜尋條件！");
    return;
  }

   try {
    const queryRef = query(collection(db, "佑康測試"), ...queryConditions);
    const querySnapshot = await getDocs(queryRef);
    const resultTable = document.getElementById("resultTable");
    resultTable.innerHTML = "";

    // 初始化統計變數
    let infoVACCount = 0;
    let activeVACCount = 0;
    let ultaCount = 0;
    let locationLostCount = 0;

    if (!querySnapshot.empty) {
      querySnapshot.forEach((docSnapshot) => {
        const data = docSnapshot.data();

        // 統計儀器種類
        if (data.儀器種類 === "InfoV.A.C") {
          infoVACCount++;
        } else if (data.儀器種類 === "ActiV.A.C") {
          activeVACCount++;
        } else if (data.儀器種類 === "ULTA") {
          ultaCount++;
        }

        // 統計地點中出現【遺失】
        if (data.地點 && data.地點.includes("遺失")) {
          locationLostCount++;
        }

        // 繼續生成表格的邏輯...
        const docId = docSnapshot.id;
        const row = document.createElement("tr");

       row.innerHTML = `
  <td>
    <select>
      <option value="庫房" ${data.區域 === "庫房" ? "selected" : ""}>庫房</option>
      <option value="北區" ${data.區域 === "北區" ? "selected" : ""}>北區</option>
      <option value="中區" ${data.區域 === "中區" ? "selected" : ""}>中區</option>
      <option value="南區" ${data.區域 === "南區" ? "selected" : ""}>南區</option>
    </select>
  </td>
  <td>
    <select id="personSelect-${docId}">
      <option value="">載入中...</option>
    </select>
  </td>
  <td>
    <select>
      <option value="InfoV.A.C" ${data.儀器種類 === "InfoV.A.C" ? "selected" : ""}>InfoV.A.C</option>
      <option value="ActiV.A.C" ${data.儀器種類 === "ActiV.A.C" ? "selected" : ""}>ActiV.A.C</option>
      <option value="ULTA" ${data.儀器種類 === "ULTA" ? "selected" : ""}>ULTA</option>
    </select>
  </td>
  <td contenteditable="true">${data.序號}</td>
  <td><input type="date" value="${formatDate(data.日期) || ''}"></td>
  <td contenteditable="true">${data.原醫院}</td>
  <td contenteditable="true">${data.原地點}</td>
  <td contenteditable="true">${data.醫院}</td>
  <td contenteditable="true">${data.地點}</td>
  <td contenteditable="true">${data.醫生姓名}</td>
  <td contenteditable="true">${data.病人姓名}</td>
  <td contenteditable="true">${data.搭配產品}</td>
  <td>
    <select>
      <option value="不在庫" ${data.庫房狀態 === "不在庫" ? "selected" : ""}>不在庫</option>
      <option value="已入庫可領取" ${data.庫房狀態 === "已入庫可領取" ? "selected" : ""}>已入庫可領取</option>
      <option value="出售" ${data.庫房狀態 === "出售" ? "selected" : ""}>出售</option>
      <option value="提供緊急使用" ${data.庫房狀態 === "提供緊急使用" ? "selected" : ""}>提供緊急使用</option>
      <option value="維修中" ${data.庫房狀態 === "維修中" ? "selected" : ""}>維修中</option>
      <option value="可領取" ${data.庫房狀態 === "可領取" ? "selected" : ""}>可領取</option>
      <option value="報廢" ${data.庫房狀態 === "報廢" ? "selected" : ""}>報廢</option>
      <option value="送原廠" ${data.庫房狀態 === "送原廠" ? "selected" : ""}>送原廠</option>
      <option value="維修完成可領取" ${data.庫房狀態 === "維修完成可領取" ? "selected" : ""}>維修完成可領取</option>
    </select>
  </td>
  <td>
    <button class="saveButton">儲存編輯</button>
    <button class="deleteButton">刪除</button>
  </td>
`;

        resultTable.appendChild(row);

        const regionSelect = row.querySelector("select");
        const personSelect = row.querySelector(`#personSelect-${docId}`);

        // 動態載入人員名單
regionSelect.addEventListener("change", async () => {
  const selectedRegion = regionSelect.value;

  try {
    const settingsDocRef = doc(db, "佑康設定", "佑康人員");
    const settingsDoc = await getDoc(settingsDocRef);

    if (settingsDoc.exists()) {
      const regionData = settingsDoc.data();
      const people = regionData[`${selectedRegion}人員`] || []; // 預設為空陣列

      // 儲存原本的第一項選項（data.儀器人員），即使清空時也會重新插入
      const defaultOption = document.createElement("option");
      defaultOption.value = data.人員 || "";
      defaultOption.textContent = data.人員 ? `${data.人員}` : "請選擇人員";
      defaultOption.selected = true; // 設定為預設選中

      // 清空選單並重新插入
      personSelect.innerHTML = "";
      personSelect.appendChild(defaultOption); // 確保第一項始終存在

      // 動態添加來自區域設定的其他人員
      if (Array.isArray(people)) {
        people.forEach((person) => {
          const option = document.createElement("option");
          option.value = person;
          option.textContent = person;

          // 避免與 data.儀器人員 重複
          if (person !== data.人員) {
            personSelect.appendChild(option);
          }
        });
      } else if (typeof people === "string") {
        const personArray = people.split(",").map((p) => p.trim());
        personArray.forEach((person) => {
          const option = document.createElement("option");
          option.value = person;
          option.textContent = person;

          // 避免與 data.儀器人員 重複
          if (person !== data.人員) {
            personSelect.appendChild(option);
          }
        });
      } else {
        console.error(
          `${selectedRegion} 人員資料格式不正確，應為陣列或逗號分隔的字串`
        );
      }
    } else {
      console.error("無法找到人員設定文件");
    }
  } catch (error) {
    console.error("載入人員資料失敗：", error);
  }
});



        regionSelect.dispatchEvent(new Event("change")); // 初始化時載入對應人員名單

        row.querySelector(".saveButton").addEventListener("click", async () => {
          const updatedData = {
             區域: regionSelect.value,
    人員: personSelect.value,
    儀器種類: row.children[2].querySelector("select").value, // 從下拉選單取得值
    序號: row.children[3].textContent.trim(),
    日期: row.children[4].querySelector("input[type='date']").value,
    原醫院: row.children[5].textContent.trim(),
    原地點: row.children[6].textContent.trim(),
    醫院: row.children[7].textContent.trim(),
    地點: row.children[8].textContent.trim(),
    醫生姓名: row.children[9].textContent.trim(),
    病人姓名: row.children[10].textContent.trim(),
    搭配產品: row.children[11].textContent.trim(),
    庫房狀態: row.children[12].querySelector("select").value, 
          };

          try {
            const docRef = doc(db, "佑康測試", docId);
            await updateDoc(docRef, updatedData);
            alert("資料已儲存！");
          } catch (error) {
            console.error("更新資料失敗：", error);
            alert("儲存失敗，請稍後再試！");
          }
        });

        row.querySelector(".deleteButton").addEventListener("click", async () => {
          try {
            const docRef = doc(db, "佑康測試", docId);
            await deleteDoc(docRef);
            row.remove();
            alert("資料已刪除！");
          } catch (error) {
            console.error("刪除資料失敗：", error);
            alert("刪除失敗，請稍後再試！");
          }
        });
      });
     const statsRow = document.createElement("tr");
      statsRow.innerHTML = `
        <td colspan="14">
          InfoV.A.C : ${infoVACCount} 台<br>
          ActiV.A.C : ${activeVACCount} 台<br>
          ULTA : ${ultaCount} 台<br>
          遺失 : ${locationLostCount} 台
        </td>
      `;
      resultTable.appendChild(statsRow);    
    } else {
      resultTable.innerHTML = "<tr><td colspan='14'>沒有符合的資料</td></tr>";
    }
  } catch (error) {
    console.error("搜尋失敗：", error);
    alert("搜尋失敗，請稍後再試！");
  }
});

  function formatDate(date) {
  const d = new Date(date);
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0'); // 月份從0開始，因此需要加1並補零
  const day = String(d.getDate()).padStart(2, '0'); // 補零以符合日期格式
  return `${year}-${month}-${day}`;
}

    
  async function clearCollection(collectionName) {
            // 使用 collection() 來獲取集合
            const querySnapshot = await getDocs(collection(db, collectionName));
            querySnapshot.forEach(async (docSnap) => {
                // 使用 deleteDoc() 來刪除文檔
                await deleteDoc(doc(db, collectionName, docSnap.id));
                console.log(`刪除文件：${docSnap.id}`);
            });
            console.log(`集合 ${collectionName} 清空完成`);
        }

        // 你可以在這裡設置一個事件來觸發清空集合的操作
        window.clearCollection = clearCollection;
</script>


總資料數: <span id="docCount"></span> 筆
<button onclick="clearCollection('佑康測試')">清空集合</button>

</body>
</html>
