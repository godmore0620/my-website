<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è³‡æ–™ç®¡ç†ç³»çµ±</title>
  <style>
   .table-container {
  width: 100%;
  overflow-x: auto; /* å…è¨±æ©«å‘æ»¾å‹• */
  white-space: nowrap; /* é˜²æ­¢å…§å®¹è‡ªå‹•æ›è¡Œ */
}

/* è®“è¡¨æ ¼æœ¬èº«ç¶­æŒå›ºå®šå¯¬åº¦ï¼Œä¸è·Ÿè‘—ç¸®æ”¾ */
table {
  width: 1500px; /* è¨­å®šä¸€å€‹è¼ƒå¤§çš„å¯¬åº¦ï¼Œç¢ºä¿ä¸æœƒè¢«å£“ç¸® */
  border-collapse: collapse;
}  
   input {
    width: 100%;
    font-size: 16px;
    border: none;
    border-bottom: 1px solid #ccc; /* æ·»åŠ åº•ç·šè®“ä½¿ç”¨è€…çŸ¥é“é€™æ˜¯è¼¸å…¥æ¡† */
    outline: none;
    background-color: transparent;
    transition: border-color 0.3s ease-in-out;}

   input:focus {
     border-bottom: 2px solid #007bff; /* èšç„¦æ™‚é¡¯ç¤ºè—è‰²ä¸‹åŠƒç·šï¼Œæå‡å¯è¦‹æ€§ */}
    select {
    font-size: 16px; /* èª¿æ•´å­—é«”å¤§å° */
    }
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .form-group {
      margin-bottom: 10px;
    }
  
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    button {
      margin-right: 5px;
    }
    input {
      width: 100%;
      max-width: 200px;
    }
  </style>
</head>
<body>

<h1>è³‡æ–™ç®¡ç†ç³»çµ±</h1>

<!-- è¼¸å…¥å€å¡Š -->
<div id="formArea">
  <h2>è¼¸å…¥/æœå°‹è³‡æ–™</h2>
  <form id="dataForm">
    <div class="form-group">
      <label for="region">å€åŸŸ:</label>
      <select id="region">
        <option value="">è«‹é¸æ“‡</option>
        <option value="åŒ—å€">åŒ—å€</option>
        <option value="ä¸­å€">ä¸­å€</option>
        <option value="å—å€">å—å€</option>
        <option value="åº«æˆ¿">åº«æˆ¿</option>
      </select>
    </div>
    <div class="form-group">
      <label for="person">äººå“¡:</label>
      <select id="person">
      <option value="">è«‹é¸æ“‡</option>
      </select>
    </div>
    <div class="form-group">
      <label for="instrument">å„€å™¨ç¨®é¡:</label>
      <input type="text" id="instrument">
    </div>
    <div class="form-group">
      <label for="serial">åºè™Ÿ:</label>
      <input type="text" id="serial">
    </div>
    <div class="form-group">
      <label for="date">æ—¥æœŸ:</label>
      <input type="date" id="date">
    </div>
    <div class="form-group">
      <label for="oldhospital">åŸé†«é™¢:</label>
      <input type="text" id="oldhospital">
    </div>
    <div class="form-group">
      <label for="oldlocation">åŸåœ°é»:</label>
      <input type="text" id="oldlocation">
    </div>
    <div class="form-group">
      <label for="hospital">é†«é™¢:</label>
      <input type="text" id="hospital">
    </div>
    <div class="form-group">
      <label for="location">åœ°é»:</label>
      <input type="text" id="location">
    </div>
     <div class="form-group">
      <label for="patient">é†«ç”Ÿå§“å:</label>
      <input type="text" id="doctor">
    </div>
      <div class="form-group">
      <label for="patient">ç—…äººå§“å:</label>
      <input type="text" id="patient">
    </div>
    <div class="form-group">
      <label for="product">æ­é…ç”¢å“:</label>
      <input type="text" id="product">
    </div>
    <div class="form-group">
      <label for="stockStatus">åº«æˆ¿ç‹€æ…‹:</label>
      <input type="text" id="stockStatus">
    </div>
    <button type="submit" id="submitButton">æäº¤</button>
    <button type="button" id="searchButton">æœå°‹</button>
    <button id="clearDataBtn">æ¸…ç©ºSupabase</button>
    <button id="syncButton">åŒ¯å…¥Sheet</button>
    <p id="status"></p>  <!-- é€™å€‹ä¸€å®šè¦æœ‰ï¼ -->

    è³‡æ–™ç­†æ•¸: <span id="recordCount">è¼‰å…¥ä¸­...</span>
    
    
  </form>
</div>

<!-- çµæœé¡¯ç¤ºå€ -->
<div id="resultArea">
  <table>
    <thead>
      <tr>
        <th>å€åŸŸ</th>
        <th>äººå“¡</th>
        <th>å„€å™¨ç¨®é¡</th>
        <th>åºè™Ÿ</th>
        <th>æ—¥æœŸ</th>
        <th>åŸé†«é™¢</th>
        <th>åŸåœ°é»</th>  
        <th>é†«é™¢</th>
        <th>åœ°é»</th>
        <th>é†«ç”Ÿå§“å</th>
        <th>ç—…äººå§“å</th>
        <th>æ­é…ç”¢å“</th>
        <th>åº«æˆ¿ç‹€æ…‹</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="resultTable">
      <tr><td colspan="14">å°šç„¡è³‡æ–™</td></tr>
    </tbody>
  </table>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient('https://cnrjbwadxrxvgjijlzll.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNucmpid2FkeHJ4dmdqaWpsemxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc3MDA5MzIsImV4cCI6MjA1MzI3NjkzMn0.qOBSnrgpNWI1g2mt9iR9S-Nvwj5kAs0vXqhdue4nIoo');
  const recordCountElement = document.getElementById('recordCount');
  const clearDataBtn = document.getElementById('clearDataBtn');
  // ç›£è½å€åŸŸé¸æ“‡çš„è®Šæ›´
  document.getElementById("region").addEventListener("change", async function () {
    const region = this.value; // å–å¾—é¸ä¸­çš„å€åŸŸ
    const personSelect = document.getElementById("person");

    // æ¸…ç©ºäººå“¡ä¸‹æ‹‰é¸å–®
    personSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';

    if (region === "åº«æˆ¿") {
      return; // å¦‚æœæ˜¯åº«æˆ¿ï¼Œä¿æŒç©ºç™½
    }

    try {
      const { data, error } = await supabase
        .from('ä½‘åº·è¨­å®š')
        .select('äººå“¡')
        .eq('å€åŸŸ', region);

      if (error) {
        console.error("Error fetching people data:", error);
        return;
      }

      data.forEach(person => {
        const option = document.createElement("option");
        option.value = person;
        option.textContent = person;
        personSelect.appendChild(option);
      });
    } catch (error) {
      console.error("Error fetching data:", error);
    }
  });

  // æäº¤è¡¨å–®äº‹ä»¶
  document.getElementById("dataForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = {
      å€åŸŸ: document.getElementById("region").value,
      äººå“¡: document.getElementById("person").value,
      å„€å™¨ç¨®é¡: document.getElementById("instrument").value,
      åºè™Ÿ: document.getElementById("serial").value,
      æ—¥æœŸ: document.getElementById("date").value,
      åŸé†«é™¢: document.getElementById("oldhospital").value,
      åŸåœ°é»: document.getElementById("oldlocation").value,
      é†«é™¢: document.getElementById("hospital").value,
      åœ°é»: document.getElementById("location").value,
      é†«ç”Ÿå§“å: document.getElementById("doctor").value,
      ç—…äººå§“å: document.getElementById("patient").value,
      æ­é…ç”¢å“: document.getElementById("product").value,
      åº«æˆ¿ç‹€æ…‹: document.getElementById("stockStatus").value
    };

    if (!formData.å€åŸŸ) {
      alert("è«‹é¸æ“‡å€åŸŸï¼");
      return;
    }

    try {
      const { data, error } = await supabase
        .from('ä½‘åº·æ¸¬è©¦')
        .upsert([formData]);

      if (error) {
        console.error("Error submitting data:", error);
        alert("æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
      } else {
        alert("è³‡æ–™å·²æäº¤ï¼");
      }

      document.getElementById("dataForm").reset();
    } catch (error) {
      console.error("æäº¤è³‡æ–™å¤±æ•—ï¼š", error);
      alert("æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
    }
  });

  // æœå°‹æŒ‰éˆ•äº‹ä»¶
  document.getElementById("searchButton").addEventListener("click", async () => {
    const region = document.getElementById("region").value;
    const person = document.getElementById("person").value;
    const instrument = document.getElementById("instrument").value;
    const serial = document.getElementById("serial").value;
    const date = document.getElementById("date").value;
    const oldhospital = document.getElementById("oldhospital").value;
    const oldlocation = document.getElementById("oldlocation").value;
    const hospital = document.getElementById("hospital").value;
    const location = document.getElementById("location").value;
    const doctor = document.getElementById("doctor").value;
    const patient = document.getElementById("patient").value;
    const product = document.getElementById("product").value;
    const stockStatus = document.getElementById("stockStatus").value;

    try {
      const { data, error } = await supabase
        .from('ä½‘åº·æ¸¬è©¦')
        .select('*')
        .ilike('å€åŸŸ', `%${region}%`)
        .ilike('äººå“¡', `%${person}%`)
        .ilike('å„€å™¨ç¨®é¡', `%${instrument}%`)
        .ilike('åºè™Ÿ', `%${serial}%`)
        .ilike('æ—¥æœŸ', `%${date}%`)
        .ilike('åŸé†«é™¢', `%${oldhospital}%`)
        .ilike('åŸåœ°é»', `%${oldlocation}%`)
        .ilike('é†«é™¢', `%${hospital}%`)
        .ilike('åœ°é»', `%${location}%`)
        .ilike('é†«ç”Ÿå§“å', `%${doctor}%`)
        .ilike('ç—…äººå§“å', `%${patient}%`)
        .ilike('æ­é…ç”¢å“', `%${product}%`)
        .ilike('åº«æˆ¿ç‹€æ…‹', `%${stockStatus}%`);

      if (error) {
        console.error("Error fetching data:", error);
        return;
      }

      const resultTable = document.getElementById("resultTable");
      resultTable.innerHTML = '';

      data.forEach(item => {
        const row = document.createElement("tr");
        row.innerHTML = `
         <td><input type="text" value="${item.å€åŸŸ}" class="edit-input"></td>
         <td><input type="text" value="${item.äººå“¡}" class="edit-input"></td>
         <td><input type="text" value="${item.å„€å™¨ç¨®é¡}" class="edit-input"></td>
         <td><input type="text" value="${item.åºè™Ÿ}" class="edit-input"></td>
         <td><input type="date" value="${item.æ—¥æœŸ}" class="edit-input"></td>
         <td><input type="text" value="${item.åŸé†«é™¢}" class="edit-input"></td>
         <td><input type="text" value="${item.åŸåœ°é»}" class="edit-input"></td>
         <td><input type="text" value="${item.é†«é™¢}" class="edit-input"></td>
         <td><input type="text" value="${item.åœ°é»}" class="edit-input"></td>
         <td><input type="text" value="${item.é†«ç”Ÿå§“å}" class="edit-input"></td>
         <td><input type="text" value="${item.ç—…äººå§“å}" class="edit-input"></td>
         <td><input type="text" value="${item.æ­é…ç”¢å“}" class="edit-input"></td>
         <td><input type="text" value="${item.åº«æˆ¿ç‹€æ…‹}" class="edit-input"></td>
         <td>
          <button class="saveButton" data-id="${item.id}">å„²å­˜</button>
          <button class="deleteButton" data-id="${item.id}">åˆªé™¤</button>
        </td>
          
        `;
        resultTable.appendChild(row);
      });
    } catch (error) {
      console.error("Error fetching data:", error);
    }
  });
 document.addEventListener("click", async function (event) {
  if (event.target.classList.contains("saveButton")) {
    const row = event.target.closest("tr");
    const id = event.target.dataset.id;

    const updatedData = {
      å€åŸŸ: row.children[0].querySelector("input").value,
      äººå“¡: row.children[1].querySelector("input").value,
      å„€å™¨ç¨®é¡: row.children[2].querySelector("input").value,
      åºè™Ÿ: row.children[3].querySelector("input").value,
      æ—¥æœŸ: row.children[4].querySelector("input").value,
      åŸé†«é™¢: row.children[5].querySelector("input").value,
      åŸåœ°é»: row.children[6].querySelector("input").value,
      é†«é™¢: row.children[7].querySelector("input").value,
      åœ°é»: row.children[8].querySelector("input").value,
      é†«ç”Ÿå§“å: row.children[9].querySelector("input").value,
      ç—…äººå§“å: row.children[10].querySelector("input").value,
      æ­é…ç”¢å“: row.children[11].querySelector("input").value,
      åº«æˆ¿ç‹€æ…‹: row.children[12].querySelector("input").value
    };

    try {
      const { error } = await supabase
        .from('ä½‘åº·æ¸¬è©¦')
        .update(updatedData)
        .eq('id', id);

      if (error) {
        console.error("æ›´æ–°å¤±æ•—:", error);
        alert("æ›´æ–°å¤±æ•—ï¼");
      } else {
        alert("æ›´æ–°æˆåŠŸï¼");
      }
    } catch (error) {
      console.error("æ›´æ–°éŒ¯èª¤:", error);
    }
  }
});  
  document.addEventListener("click", async function (event) {
  if (event.target.classList.contains("deleteButton")) {
    const row = event.target.closest("tr");
    const id = event.target.dataset.id;

    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è³‡æ–™å—ï¼Ÿ")) return;

    try {
      const { error } = await supabase
        .from('ä½‘åº·æ¸¬è©¦')
        .delete()
        .eq('id', id);

      if (error) {
        console.error("åˆªé™¤å¤±æ•—:", error);
        alert("åˆªé™¤å¤±æ•—ï¼");
      } else {
        row.remove();
        alert("åˆªé™¤æˆåŠŸï¼");
      }
    } catch (error) {
      console.error("åˆªé™¤éŒ¯èª¤:", error);
    }
  }
});

async function getRecordCount() {
            let { count, error } = await supabase
                .from("ä½‘åº·æ¸¬è©¦")
                .select("*", { count: "exact", head: true });

            if (error) {
                console.error("è®€å–è³‡æ–™éŒ¯èª¤:", error);
                recordCountElement.textContent = "è¼‰å…¥å¤±æ•—";
            } else {
                recordCountElement.textContent = count;
            }
        }

        // ğŸš€ æ¸…ç©º `ä½‘åº·æ¸¬è©¦` è³‡æ–™è¡¨
        async function clearAllData() {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™å€‹å‹•ä½œç„¡æ³•å¾©åŸï¼")) return;
            
            let { error } = await supabase.from("ä½‘åº·æ¸¬è©¦").delete().neq("id", 0);

            if (error) {
                console.error("åˆªé™¤è³‡æ–™éŒ¯èª¤:", error);
                alert("åˆªé™¤å¤±æ•—");
            } else {
                alert("è³‡æ–™å·²æ¸…ç©º");
                getRecordCount();  // é‡æ–°å–å¾—ç­†æ•¸
            }
        }

        // ğŸ”„ åˆæ¬¡è¼‰å…¥æ™‚ç²å–è³‡æ–™ç­†æ•¸
        getRecordCount();

        // ğŸ“Œ ç¶å®šæ¸…ç©ºæŒ‰éˆ•
        clearDataBtn.addEventListener('click', clearAllData);  
 
 document.addEventListener("DOMContentLoaded", function() {
            document.getElementById("syncButton").addEventListener("click", function() {
                fetch("https://script.google.com/macros/s/ä½ çš„æ–°ID/exec")  // æ›¿æ›ä½ çš„ Google Apps Script URL
                .then(response => response.json())
                .then(data => {
                    document.getElementById("status").innerText = "åŒæ­¥æˆåŠŸï¼š" + data.message;
                })
                .catch(error => {
                    document.getElementById("status").innerText = "åŒæ­¥å¤±æ•—ï¼š" + error;
                });
            });
        });

  </script>

</body>
</html>
